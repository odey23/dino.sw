<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistik Dino Wallet</title>
    <link rel="stylesheet" href="statsstyle.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
   
</head>

<body>
    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "/";
    </script>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon"><img src="/assets/Nailoong.jpeg" alt=""></div>
            <div class="logo-text">Dino Wallet</div>
        </div>

        <nav>
            <div class="nav-section">
                <div class="nav-label">MENU</div>
                <a href="#" class="nav-item" id="dashboardBtn">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item active">
                    <span>üìà</span>
                    <span>Analytics</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="page-title">
                <h1>Statistik Kotak Amal</h1>
                <p>Your recent transaction activity and all</p>
            </div>

            <div class="top-actions">
                <div class="search-box">
                </div>

                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role" id="userRole">admin@example.com</div>
                    </div>
                </div>

                <button class="btn-logout" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button id="btnDay" onclick="setMode('day')">üìÖ Harian</button>
                <button id="btnMonth" onclick="setMode('month')">üìÜ Bulanan</button>
                <button id="btnYear" onclick="setMode('year')">üóì Tahunan</button>
            </div>

            <div class="filter" id="filterDay">
                <label for="dateSelect">Pilih Tanggal:</label>
                <input type="date" id="dateSelect" onchange="updateDay()">
            </div>

            <div class="filter" id="filterMonth" style="display:none;">
                <label>Bulan:</label>
                <select id="monthSelect" onchange="updateMonth()">
                    <option value="0">Januari</option>
                    <option value="1">Februari</option>
                    <option value="2">Maret</option>
                    <option value="3">April</option>
                    <option value="4">Mei</option>
                    <option value="5">Juni</option>
                    <option value="6">Juli</option>
                    <option value="7">Agustus</option>
                    <option value="8">September</option>
                    <option value="9">Oktober</option>
                    <option value="10">November</option>
                    <option value="11">Desember</option>
                </select>
                <label>Tahun:</label>
                <select id="yearSelectM" onchange="updateMonth()"></select>
            </div>

            <div class="filter" id="filterYear" style="display:none;">
                <label>Pilih Tahun:</label>
                <select id="yearSelectY" onchange="updateYear()"></select>
            </div>

            <div class="stats-card">
                <h2 id="statsTitle">Total Donasi</h2>
                <div class="amount" id="statsValue">Rp 0</div>
                <button class="btn-export" id="exportBtn" onclick="exportToExcel()">
                    üì§ Export Data ke Excel
                </button>
            </div>

            <div class="charts-container">
                <div class="chart-wrapper">
                    <h3>üìä Grafik Donasi</h3>
                    <canvas id="donationChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h3>üç© Distribusi Nominal</h3>
                    <canvas id="denomChart"></canvas>
                </div>
            </div>

            <div class="table-container" id="dailyList">
            </div>
        </div>
    </main>

    <div class="overlay" id="logoutPopup">
        <div class="popup">
            <h3>Apakah anda mau logout?</h3>
            <div class="actions">
                <button class="btn btn-yes" id="logoutYes">Yes</button>
                <button class="btn btn-no" id="logoutNo">No</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="adminPopup">
        <div class="popup">
            <h3>Maaf, hanya administrator yang bisa melakukan ini!</h3>
            <div class="actions">
                <button class="btn btn-ok" id="adminOk">OK</button>
            </div>
        </div>
    </div>

    <script>
        function getLocalDate(dateString) {
            const date = new Date(dateString);
            return {
                year: date.getFullYear(),
                month: date.getMonth(),
                date: date.getDate(),
                hours: date.getHours()
            };
        }

        function formatDateOnly(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatTimeOnly(dateString) {
            const date = new Date(dateString);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        const userName = document.getElementById("userName");
        const userRole = document.getElementById("userRole");
        const userAvatar = document.getElementById("userAvatar");
        const username = localStorage.getItem("username") || "User";
        const role = localStorage.getItem("role") || "User";
        const displayName = role === "admin" ? "Admin" : role === "moderator" ? "Moderator" : username;
        
        userName.textContent = displayName;
        userRole.textContent = `${role}@example.com`;
        userAvatar.textContent = displayName.charAt(0).toUpperCase();

        document.getElementById("dashboardBtn").addEventListener("click", (e) => {
            e.preventDefault();
            window.location.href = "/";
        });

        const logoutBtn = document.getElementById("logoutBtn");
        const logoutPopup = document.getElementById("logoutPopup");
        const logoutYes = document.getElementById("logoutYes");
        const logoutNo = document.getElementById("logoutNo");

        logoutBtn.addEventListener("click", () => {
            logoutPopup.style.display = "flex";
        });

        logoutYes.addEventListener("click", () => {
            localStorage.removeItem("token");
            localStorage.removeItem("role");
            localStorage.removeItem("username");
            window.location.href = "/";
        });

        logoutNo.addEventListener("click", () => {
            logoutPopup.style.display = "none";
        });

        document.getElementById("adminOk").addEventListener("click", () => {
            document.getElementById("adminPopup").style.display = "none";
        });

        let chart, denomChart, allData = [], mode = 'day', currentList = [];

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const res = await fetch('http://localhost:3000/api/donations', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                allData = await res.json();
                isiDropdownTahun();
                setMode('day');
            } catch (err) {
                console.error(err);
                alert("Gagal mengambil data donasi.");
            }
        });

        function isiDropdownTahun() {
            const years = [...new Set(allData.map(i => getLocalDate(i.created_at).year))].sort();
            const ySelectM = document.getElementById("yearSelectM");
            const ySelectY = document.getElementById("yearSelectY");
            years.forEach(y => {
                ySelectM.innerHTML += `<option value="${y}">${y}</option>`;
                ySelectY.innerHTML += `<option value="${y}">${y}</option>`;
            });
        }

        function setMode(newMode) {
            mode = newMode;
            document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
            document.getElementById("btn" + capitalize(newMode)).classList.add("active");
            document.getElementById("filterDay").style.display = newMode === 'day' ? "block" : "none";
            document.getElementById("filterMonth").style.display = newMode === 'month' ? "block" : "none";
            document.getElementById("filterYear").style.display = newMode === 'year' ? "block" : "none";
            if (newMode === 'day') updateDay();
            if (newMode === 'month') updateMonth();
            if (newMode === 'year') updateYear();
        }

        function updateDay() {
            let selDate;
            const dateInput = document.getElementById("dateSelect").value;
            
            if (dateInput) {
                const [year, month, day] = dateInput.split('-').map(Number);
                selDate = { year, month: month - 1, date: day };
            } else {
                const now = new Date();
                selDate = {
                    year: now.getFullYear(),
                    month: now.getMonth(),
                    date: now.getDate()
                };
            }

            const displayDate = new Date(selDate.year, selDate.month, selDate.date);
            const label = displayDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            
            const list = allData.filter(i => {
                const itemDate = getLocalDate(i.created_at);
                return itemDate.date === selDate.date && 
                       itemDate.month === selDate.month && 
                       itemDate.year === selDate.year;
            });
            
            tampilkanData(list, label, "jam", 24, i => getLocalDate(i.created_at).hours);
        }

        function updateMonth() {
            const m = Number(document.getElementById("monthSelect").value);
            const y = Number(document.getElementById("yearSelectM").value);
            const label = `${new Date(y, m).toLocaleString('id-ID', { month: 'long' })} ${y}`;
            
            const list = allData.filter(i => {
                const itemDate = getLocalDate(i.created_at);
                return itemDate.month === m && itemDate.year === y;
            });
            
            const days = new Date(y, m + 1, 0).getDate();
            tampilkanData(list, label, "hari", days, i => getLocalDate(i.created_at).date);
        }

        function updateYear() {
            const y = Number(document.getElementById("yearSelectY").value);
            const label = `Tahun ${y}`;
            
            const list = allData.filter(i => getLocalDate(i.created_at).year === y);
            tampilkanData(list, label, "bulan", 12, i => getLocalDate(i.created_at).month);
        }

        function tampilkanData(list, label, tipe, jumlah, getKey) {
            currentList = list;
            const total = list.reduce((s, i) => s + Number(i.amount), 0);
            document.getElementById("statsTitle").textContent = `Total Donasi (${label})`;
            document.getElementById("statsValue").textContent = `Rp ${total.toLocaleString('id-ID')}`;

            let grup, labels;
            
            if (tipe === "jam") {
                grup = Array.from({ length: 24 }, (_, idx) => 
                    list.filter(i => getKey(i) === idx).reduce((s, i) => s + Number(i.amount), 0)
                );
                labels = Array.from({ length: 24 }, (_, i) => i + ":00");
            } else if (tipe === "hari") {
                grup = Array.from({ length: jumlah }, (_, idx) => 
                    list.filter(i => getKey(i) === (idx + 1)).reduce((s, i) => s + Number(i.amount), 0)
                );
                labels = Array.from({ length: jumlah }, (_, i) => i + 1);
            } else {
                grup = Array.from({ length: 12 }, (_, idx) => 
                    list.filter(i => getKey(i) === idx).reduce((s, i) => s + Number(i.amount), 0)
                );
                labels = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
            }

            const ctx = document.getElementById("donationChart").getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: "Total Donasi (Rp)",
                        data: grup,
                        backgroundColor: "#f9a825",
                        borderRadius: 8
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const container = document.getElementById("dailyList");
            if (!list.length) {
                container.innerHTML = `<div class="no-data">üì≠ Tidak ada donasi untuk ${label}</div>`;
                if (denomChart) denomChart.destroy();
                return;
            }

            let html = `<h3>üìÖ Daftar Donasi (${label})</h3><table><thead><tr><th>No</th><th>Nominal</th><th>Warna</th><th>Tanggal</th><th>Jam</th></tr></thead><tbody>`;
            list.forEach((item, i) => {
                const tanggal = formatDateOnly(item.created_at);
                const jam = formatTimeOnly(item.created_at);
                html += `<tr><td>${i + 1}</td><td>Rp ${Number(item.amount).toLocaleString('id-ID')}</td><td>${item.metadata?.warna || '-'}</td><td>${tanggal}</td><td>${jam}</td></tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;

            updatePieChart(list);
        }

        function updatePieChart(list) {
            const denomCounts = {};
            list.forEach(item => {
                const amt = Number(item.amount);
                denomCounts[amt] ? denomCounts[amt]++ : denomCounts[amt] = 1;
            });

            const labels = Object.keys(denomCounts).sort((a, b) => a - b).map(v => "Rp " + Number(v).toLocaleString('id-ID'));
            const data = Object.values(denomCounts);

            const ctxPie = document.getElementById("denomChart").getContext("2d");
            if (denomChart) denomChart.destroy();
            denomChart = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        label: "Jumlah Donasi per Nominal",
                        data,
                        backgroundColor: labels.map((_, i) => `hsl(${i * 60 % 360},70%,50%)`)
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function exportToExcel() {
            if (role !== "admin") {
                document.getElementById("adminPopup").style.display = "flex";
                return;
            }
            if (!currentList.length) return;

            const rows = currentList.map((item, i) => ({
                No: i + 1,
                Nominal: "Rp " + Number(item.amount).toLocaleString('id-ID'),
                Warna: item.metadata?.warna || '-',
                Tanggal: formatDateOnly(item.created_at),
                Jam: formatTimeOnly(item.created_at)
            }));

            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Donasi");
            XLSX.writeFile(wb, "Data_Donasi.xlsx");
        }

        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }
    </script>
</body>
</html>