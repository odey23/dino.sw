<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Statistik Dino'sWalleet</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: "Poppins", sans-serif; margin: 0; background: #f4f6f8; }
    header { background: #4e54c8; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    header h2 { margin: 0; }
    main { padding: 1rem 2rem; }
    .tabs { text-align: center; margin-bottom: 15px; }
    .tabs button { background: #e9ecef; border: none; padding: 8px 15px; margin: 5px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .tabs button:hover, .tabs button.active { background: #4e54c8; color: white; }
    .filter { margin-top: 15px; text-align: center; }
    .filter input, .filter select { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; margin: 5px; }
    .stats { text-align: center; margin-top: 20px; background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .stats h2 { margin-bottom: 5px; }
    .stats p { font-size: 1.4em; font-weight: bold; color: #4e54c8; }
    #exportBtn { display: block; margin: 15px auto 0 auto; background: #28a745; color: white; border: none; padding: 10px 18px; font-size: 15px; font-weight: 600; border-radius: 6px; cursor: pointer; }
    #exportBtn:hover { background: #218838; }
    .chart-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; margin-top: 25px; }
    canvas { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: #4e54c8; color: white; }
    tbody tr:nth-child(even) { background: #f2f2f2; }
    h3 { margin-top: 30px; color: #4e54c8; }
    .btn { padding: 0.6rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; }
    .btn-secondary { background: #6368d9; color: white; margin-right: 0.5rem; }
    .btn-danger { background: #e74c3c; color: white; }

    #logoutPopup, #adminPopup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; }
    #logoutPopup div, #adminPopup div { background:white; padding:20px 30px; border-radius:10px; text-align:center; max-width:400px; width:90%; }
    #logoutPopup button, #adminPopup button { padding:8px 15px; border-radius:6px; cursor:pointer; margin-right:10px; font-weight:600; }
    #logoutYes { background: white; color: #4e54c8; border: 2px solid #4e54c8; }
    #logoutYes:hover { background: #4e54c8; color: white; }
    #logoutNo { background: red; color: white; border: none; margin-left:10px; }
    #logoutNo:hover { background: darkred; }
    #adminOk { background: #4e54c8; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; }
    #adminOk:hover { background: #3b40a0; }
  </style>
</head>
<body>
<script>
  const token = localStorage.getItem("token");
  if (!token) window.location.href = "/";
</script>

<header>
  <h2>Kotak Amal Statistics</h2>
  <div>
    <button class="btn btn-secondary" id="statsBtn">Dashboard</button>
    <span id="username"></span>
    <button class="btn btn-danger" id="logoutBtn">Logout</button>
  </div>
</header>

<div id="logoutPopup">
  <div>
    <h3>Apakah anda mau logout?</h3>
    <button id="logoutYes">Yes</button>
    <button id="logoutNo">No</button>
  </div>
</div>

<div id="adminPopup">
  <div>
    <h3>Maaf, hanya administrator yang bisa melakukan ini!</h3>
    <button id="adminOk">OK</button>
  </div>
</div>

<main>
  <div class="tabs">
    <button id="btnDay" onclick="setMode('day')">Harian</button>
    <button id="btnMonth" onclick="setMode('month')">Bulanan</button>
    <button id="btnYear" onclick="setMode('year')">Tahunan</button>
  </div>

  <div class="filter" id="filterDay">
    <label for="dateSelect">Tanggal: </label>
    <input type="date" id="dateSelect" onchange="updateDay()">
  </div>

  <div class="filter" id="filterMonth" style="display:none;">
    <label>Bulan: </label>
    <select id="monthSelect" onchange="updateMonth()">
      <option value="0">Januari</option><option value="1">Februari</option>
      <option value="2">Maret</option><option value="3">April</option>
      <option value="4">Mei</option><option value="5">Juni</option>
      <option value="6">Juli</option><option value="7">Agustus</option>
      <option value="8">September</option><option value="9">Oktober</option>
      <option value="10">November</option><option value="11">Desember</option>
    </select>
    <label>Tahun: </label>
    <select id="yearSelectM" onchange="updateMonth()"></select>
  </div>

  <div class="filter" id="filterYear" style="display:none;">
    <label>Tahun: </label>
    <select id="yearSelectY" onchange="updateYear()"></select>
  </div>

  <section class="stats">
    <h2 id="statsTitle">Total Donasi</h2>
    <p id="statsValue">Rp 0</p>
    <button id="exportBtn" onclick="exportToExcel()">ðŸ“¤ Export Data ke Excel</button>
  </section>

  <div class="chart-container">
  <canvas id="donationChart" width="500" height="300"></canvas>
  <div style="transform: scale(1.1); transform-origin: top center;">
    <canvas id="denomChart" width="300" height="300"></canvas>
  </div>
</div>

  <section id="dailyList"></section>
</main>

<script>
const usernameEl = document.getElementById("username");
const username = localStorage.getItem("username") || "User";
const role = localStorage.getItem("role") || "User";
usernameEl.textContent = `User: ${role==="admin"?"Admin":role==="moderator"?"Moderator":username}`;

const logoutBtn = document.getElementById("logoutBtn");
const logoutPopup = document.getElementById("logoutPopup");
const logoutYes = document.getElementById("logoutYes");
const logoutNo = document.getElementById("logoutNo");
logoutBtn.addEventListener("click",()=>{logoutPopup.style.display="flex";});
logoutYes.addEventListener("click",()=>{localStorage.removeItem("token"); localStorage.removeItem("role"); localStorage.removeItem("username"); window.location.href="/";});
logoutNo.addEventListener("click",()=>{logoutPopup.style.display="none";});

document.getElementById("statsBtn").addEventListener("click",()=>{window.location.href="/";});
document.getElementById("adminOk").addEventListener("click",()=>{document.getElementById("adminPopup").style.display="none";});

let chart, denomChart, allData=[], mode='day', currentList=[];

document.addEventListener("DOMContentLoaded", async()=>{
  try{
    const res = await fetch('http://localhost:3000/api/donations',{headers:{'Authorization':`Bearer ${token}`}});
    allData = await res.json();
    isiDropdownTahun();
    setMode('day');
  } catch(err){console.error(err);alert("Gagal mengambil data donasi.");}
});

function isiDropdownTahun(){
  const years=[...new Set(allData.map(i=>new Date(i.created_at).getFullYear()))].sort();
  const ySelectM=document.getElementById("yearSelectM");
  const ySelectY=document.getElementById("yearSelectY");
  years.forEach(y=>{ySelectM.innerHTML+=`<option value="${y}">${y}</option>`; ySelectY.innerHTML+=`<option value="${y}">${y}</option>`;});
}

function setMode(newMode){
  mode=newMode;
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn"+capitalize(newMode)).classList.add("active");
  document.getElementById("filterDay").style.display=newMode==='day'?"block":"none";
  document.getElementById("filterMonth").style.display=newMode==='month'?"block":"none";
  document.getElementById("filterYear").style.display=newMode==='year'?"block":"none";
  if(newMode==='day') updateDay();
  if(newMode==='month') updateMonth();
  if(newMode==='year') updateYear();
}

function updateDay(){
  const sel=document.getElementById("dateSelect").value?new Date(document.getElementById("dateSelect").value):new Date();
  const label=sel.toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'});
  const list=allData.filter(i=>{const t=new Date(i.created_at); return t.getDate()===sel.getDate() && t.getMonth()===sel.getMonth() && t.getFullYear()===sel.getFullYear();});
  tampilkanData(list,label,"jam",24,i=>new Date(i.created_at).getHours());
}

function updateMonth(){
  const m=Number(document.getElementById("monthSelect").value);
  const y=Number(document.getElementById("yearSelectM").value);
  const label=`${new Date(y,m).toLocaleString('id-ID',{month:'long'})} ${y}`;
  const list=allData.filter(i=>{const t=new Date(i.created_at); return t.getMonth()===m && t.getFullYear()===y;});
  const days=new Date(y,m+1,0).getDate();
  tampilkanData(list,label,"hari",days,i=>new Date(i.created_at).getDate());
}

function updateYear(){
  const y=Number(document.getElementById("yearSelectY").value);
  const label=`Tahun ${y}`;
  const list=allData.filter(i=>new Date(i.created_at).getFullYear()===y);
  tampilkanData(list,label,"bulan",12,i=>new Date(i.created_at).getMonth());
}

function tampilkanData(list,label,tipe,jumlah,getKey){
  currentList=list;
  const total=list.reduce((s,i)=>s+Number(i.amount),0);
  document.getElementById("statsTitle").textContent=`Total Donasi (${label})`;
  document.getElementById("statsValue").textContent=`Rp ${total.toLocaleString('id-ID')}`;

  const grup=Array.from({length:jumlah},(_,idx)=>list.filter(i=>getKey(i)===idx).reduce((s,i)=>s+Number(i.amount),0));

  const labels=tipe==="jam"?Array.from({length:24},(_,i)=>i+":00")
    :tipe==="hari"?Array.from({length:jumlah},(_,i)=>i+1)
    :["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];

  const ctx=document.getElementById("donationChart").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:"Total Donasi (Rp)",data:grup,backgroundColor:"#4e54c8"}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

  const container=document.getElementById("dailyList");
  if(!list.length){container.innerHTML=`<h3>Tidak ada donasi untuk ${label}</h3>`; if(denomChart) denomChart.destroy(); return;}

  let html=`<h3>ðŸ“… Daftar Donasi (${label})</h3><table><thead><tr><th>No</th><th>Nominal</th><th>Warna</th><th>Tanggal</th><th>Jam</th></tr></thead><tbody>`;
  list.forEach((item,i)=>{
    const t=new Date(item.created_at);
    const tanggal=t.toLocaleDateString('id-ID');
    const jam=t.toLocaleTimeString('id-ID',{hour12:false});
    html+=`<tr><td>${i+1}</td><td>Rp ${Number(item.amount).toLocaleString('id-ID')}</td><td>${item.metadata?.warna||'-'}</td><td>${tanggal}</td><td>${jam}</td></tr>`;
  });
  html+=`</tbody></table>`;
  container.innerHTML=html;

  updatePieChart(list);
}

// PIE CHART DENOM
function updatePieChart(list){
  const denomCounts={};
  list.forEach(item=>{const amt=Number(item.amount); denomCounts[amt]?denomCounts[amt]++:denomCounts[amt]=1;});

  const labels=Object.keys(denomCounts).sort((a,b)=>a-b).map(v=>"Rp "+Number(v).toLocaleString('id-ID'));
  const data=Object.values(denomCounts);

  const ctxPie=document.getElementById("denomChart").getContext("2d");
  if(denomChart) denomChart.destroy();
  denomChart=new Chart(ctxPie,{
    type:'pie',
    data:{labels,datasets:[{label:"Jumlah Donasi per Nominal",data,backgroundColor:labels.map((_,i)=>`hsl(${i*60%360},70%,50%)`)}]},
    options:{plugins:{legend:{position:'right'}}}
  });
}

function exportToExcel(){
  if(role!=="admin"){document.getElementById("adminPopup").style.display="flex"; return;}
  if(!currentList.length) return;

  const rows=currentList.map((item,i)=>({
    No:i+1,
    Nominal:"Rp "+Number(item.amount).toLocaleString('id-ID'),
    Warna:item.metadata?.warna||'-',
    Tanggal:new Date(item.created_at).toLocaleDateString('id-ID'),
    Jam:new Date(item.created_at).toLocaleTimeString('id-ID',{hour12:false})
  }));

  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Donasi");
  XLSX.writeFile(wb,"Data_Donasi.xlsx");
}

function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}
</script>
</body>
</html>
